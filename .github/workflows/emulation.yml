name: Emulate latest

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  emulation:
    name:
    runs-on: emuso

    steps:
      - uses: actions/setup-python@v3
        with:
          python-version: "3.9"
        env:
          USER: tvorogme

      - name: Download emulator
        run: |
          sudo apt update -y
          sudo apt install -y wget git
          wget https://dton.io/media/libemulator.so
          mv libemulator.so /tmp/libemulator.so

      - name: Install deps
        run: python -m pip install git+https://github.com/disintar/tonemuso.git

      - name: Run emulation only MC
        run: |
          touch failed_txs.json
          tonemuso
          mv ./failed_txs.json /tmp
        env:
          LITESERVER_SERVER: ${{ secrets.LITESERVER_SERVER }}
          LITESERVER_PORT: ${{ secrets.LITESERVER_PORT }}
          LITESERVER_PUBKEY: ${{ secrets.LITESERVER_PUBKEY }}
          EMULATOR_PATH: "/tmp/libemulator.so"
          TO_EMULATE_MC_BLOCKS: 1000
          NPROC: 16
          CHUNK_SIZE: 1000
          ONLYMC_BLOCK: 1
          EMUSO_LOGLEVEL: 2

      - name: Run emulation
        run: |
          touch failed_txs.json
          tonemuso
          mv ./failed_txs.json /tmp
        env:
          LITESERVER_SERVER: ${{ secrets.LITESERVER_SERVER }}
          LITESERVER_PORT: ${{ secrets.LITESERVER_PORT }}
          LITESERVER_PUBKEY: ${{ secrets.LITESERVER_PUBKEY }}
          EMULATOR_PATH: "/tmp/libemulator.so"
          TO_EMULATE_MC_BLOCKS: 1000
          NPROC: 16
          CHUNK_SIZE: 1000

      - name: 50k
        run: |
          touch failed_txs.json
          tonemuso
          mv ./failed_txs.json /tmp
        env:
          LITESERVER_SERVER: ${{ secrets.LITESERVER_SERVER }}
          LITESERVER_PORT: ${{ secrets.LITESERVER_PORT }}
          LITESERVER_PUBKEY: ${{ secrets.LITESERVER_PUBKEY }}
          EMULATOR_PATH: "/tmp/libemulator.so"
          TO_EMULATE_MC_BLOCKS: 50000
          NPROC: 16
          CHUNK_SIZE: 2000

      - uses: actions/upload-artifact@v4
        with:
          name: failed_txs
          path: /tmp/failed_txs.json